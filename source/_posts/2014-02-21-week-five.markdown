---
layout: post
title: "Polina on Rails: Week Five"
date: 2014-02-21 02:44:59 -0500
comments: true
categories: 
published: true
---

Site with subscription billing using Stripe, and Recurly

A web application with recurring billing using Stripe. This can be used for a membership site, subscription site, or a SaaS site (software as a service)

What I'm going to use for this tutorial:

Stripe -- recurring billing
Devise -- user management and authentication
CanCan with Rolify for authorization (Rolify gives you role-based authorization)
Twitter Bootstrap -- front end framework for CSS styling

Membership sites: restrict access to content
	Articles, videos, forums
SaaS limit use of web-based software

	Revenue model is the same: subscription based services, usually payed monthly

Basic functionality that all SaaS, membership, subscription based web applications need:

* Content/web functionality to deliver
* Landing pages to convert visitors to paying customers
* User management to register/remove users
* access control to limit site wide access
* authorization management to restrict access to content or services based on role or other characteristics
* account management to maintain records/subscription status
* recurring billing system for periodic payment transactions

####Features my site will have:

* tiered pricing for multiple subscription plans
* optional "free trial" subscription
* Stripe with no local cc storage
* PCI compliance using Stripe JS library
* Stripe for recurring billing, retries for payment failing, subscription cancelling
* Paid subscriptions created after successful cc transactions
* subscribers can upgrade/downgrade plans
* subscribers can cancel subscription plans
* configure the subscription renewal period (it defaults to one month)
* administrator can change subscription plan or delete user

####What I do not have:
* Basecamp style subdomains (each user gets their own subdomain)
* multitenancy database segmentation (using Apartment gem)

####Architecture of application:

* User management with Devise (register/remove users)
* Authentication with Devise (login/logout)
* Authorization management with CanCan and Rolify (access determined by role, in this case subscription plan)
* account management to maintain records of subscription status
* recurring billing with Stripe
* landing pages
* content or service pages

How we're creating our account managment system: we need to keep subscription records: we'll combine Stripe for user management and Devise for our account management. 

####Two ways to build a recurring billing system:
* Build a complete billing managment system in your application. You would need to build a mechanism for checking for expiring subscriptions (daily cron job) and something to initiate payment requests through stripe when a user's account is due. This means you would only use Stripe for processing cc transactions.

* Stripe provides complete recurring billing, so we'll use Stripe's API to supply a billing management system for us. 

####Key challenges/requirements

* Make sure recurring billing and account managment are in sync. Stripe provides webhooks to make sure this happens. Stripe will initiate an HTTP request to our app and that will tell us we can change a subscription status.

* PCI compliance: key requirement for any ecommerce site. This will minimize risk of customer cc exposure. Your website will meet PCI compliance if you accept payment information through the Stripe JS library and serve your payment page through SSL.

Thinking through this problem as an engineer:

Software engineers attempt to model real-world objects and behavoirs in their applications and because of that they try to choose descriptive names for the objects and methods they use in order to reduce ambiguity and increase the understanding of the purpose of the application. In this example our most important object will be a "User" but it could also be an "Account" or a "Member". 

Attributes of the User:
	Important:
	-email address
	-password
	-cc number/Stripe customer id number
	- role id/subscription plan
		Role model supplied by Rolify gem

	Less important:
	-name
	-creation date
	-other meta data etc

All of these attributes could be in themselves separate objects that are associated through our user through a key/value pair. But in this application the attributes will just be attributes, not separate objects. 

Instead of having a cc number in our application we're going to have a Stripe customer id that serves as an indirect reference to a credit card number. That will let us ask Stripe to bill the user. 

####Accounts for this app:

* Recurring billing: Stripe
* Merchant account: a line of credit that allows a business to accept cc payments from its customers. A merchant account doesn't actually hold money. It's just a holding ground for cc payments.- Stripe 
* Hosting: Heroku 
* Email: Gmail
* Source control repository: Git

####SSL
* wise to host any webapp that requires login through an ssl connection. This requires setting up SSL and applying for an SSL certificate if necessary

####Infrastructure for email
* company email
* email sent from the app ("transactional email")
* broadcast email for newsletters and announcements

There's no good answer for all three types. General I use Gmail for company email, Mandrill forTransactional email, and MailChimp for mailing list (marketing type emails).

git diff, hg diff

Domain registration: NameCheap

####Git workflow protips:
If you're working commercially or on an open source project you should get in the habit of creating a git branch each time you begin work to implement a feature. When the new feature is complete you can merge the branch and squash the commits to your comrads see just one commit for the entire feature. 







